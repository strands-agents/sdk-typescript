name: Strands Agent Runner

on:
  workflow_call:
    inputs:
      system_prompt:
        description: 'System prompt for the agent'
        required: true
        type: string
      session_id:
        description: 'Session ID for the agent execution'
        required: true
        type: string
      task_prompt:
        description: 'Task prompt for the agent'
        required: true
        type: string
    secrets:
      AWS_ROLE_ARN:
        description: 'AWS IAM role ARN for authentication'
        required: true
      TYPESCRIPT_SESSIONS_BUCKET:
        description: 'S3 bucket for session storage'
        required: true

jobs:
  run-agent:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: '.github/scripts/requirements.txt'

      - name: Install Strands Agents
        run: |
          echo "ðŸ“¦ Installing from requirements.txt"
          uv pip install --system -r .github/scripts/requirements.txt --quiet

      - name: Configure Git
        run: |
          git config --global user.name "Strands Agent"
          git config --global user.email "217235299+strands-agent@users.noreply.github.com"
          git config --global core.pager cat
          PAGER=cat

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-StrandsAgent-${{ github.run_id }}
          aws-region: us-west-2
          mask-aws-account-id: true

      - name: Execute strands command
        timeout-minutes: 60
        env:
          # GitHub Configuration
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_ACTOR: ${{ github.actor }}

          # Task Configuration
          INPUT_TASK: ${{ inputs.task_prompt }}
          INPUT_SYSTEM_PROMPT: ${{ inputs.system_prompt }}

          # AWS Configuration
          AWS_REGION: 'us-west-2'

          # Session Manager
          S3_SESSION_BUCKET: ${{ secrets.TYPESCRIPT_SESSIONS_BUCKET }}
          SESSION_ID: ${{ inputs.session_id }}
        run: |
          uv run .github/scripts/agent_runner.py "$INPUT_TASK"
